parameters:
  - name: 'tag_override'
    type: string
    default: '$(Build.BuildNumber)'
  - name: 'dockerPassword'
    type: string
  - name: 'cleanUpAzureResources'
    type: boolean
    default: true

variables:
  tag: ${{ parameters.tag_override }}
  armServiceConn: contoso_devops_arm_connection
  dockerRepositoryName: microsoft-gdc/project-staffing
  storageName: prjstfartifacts
  containerName: repository
  testDeploymentName: prj-stf-3ofyrz
  location: westus
  subscriptionId: 894f56bb-ecf5-4a8b-a3e1-6b67703d7c1c
  artifactStorageAccountName: prjstfartifacts
  parameterFile: '$(Build.SourcesDirectory)/solutions/projectstaffing/test-pipeline-param.json'

trigger: none

resources:
  - repo: self

pool:
  vmImage: ubuntu-latest

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: $(armServiceConn)
      scriptType: 'bash'
      scriptLocation:  'scriptPath'
      workingDirectory: solutions/projectstaffing/deployment/arm
      scriptPath: solutions/projectstaffing/deployment/arm/install.sh
      arguments: '--deployment-name $(testDeploymentName) --location $(location) --docker-password $(dockerPassword) --subscription $(subscriptionId) --remote-artifacts-location $(artifactStorageAccountName) --parameter-file $(parameterFile) --no-input'
      addSpnToEnvironment: true

  - task: AzureCLI@2
    inputs:
      condition: and(${{ parameters.cleanUpAzureResources }}, succeeded())
      azureSubscription: $(armServiceConn)
      scriptType: 'bash'
      scriptLocation:  'scriptPath'
      workingDirectory: solutions/projectstaffing/deployment/arm
      scriptPath: solutions/projectstaffing/deployment/arm/uninstall.sh
      arguments: ' --deployment-name $(testDeploymentName) --subscription $(subscriptionId) --no-input '
      addSpnToEnvironment: true